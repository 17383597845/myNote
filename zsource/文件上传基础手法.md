# 文件上传第一式（禁JS）

## （1）来到第一关，我们查看源代码：

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190525111736767-984582932.png)

上图可以发现，上传的限制代码块写在js函数内，因此我们可以考虑将js的开关禁掉，直接上传木马的方式，其实，似乎也可以不禁js，直接burp抓包后修改图片类型，一样可以上传成功。

## （2）上传一句话木马.php,发现直接上传成功，然后在页面进行复制图像地址，可以查看到上传的

> <?php eval($_POST['kkk']);?>

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190529160713053-165901550.png)

 ![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190529161154495-2094692196.png)

## （3）使用菜刀对木马进行连接，发现连接成功，第一关顺利通关

 ![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190529161403132-951714303.png)

---

# 文件上传第二式（改Content-Type） 

##  （1）来到第二关卡，这一关又该如何突破呢？老实说如果纯说技术的话，这关能很快速就做出来，但是，我们不能做脚本小子，我们需要了解原理，为什么只需要改一下Content-Type就能绕过上传呢？首先，我们可以观察一下我们上传php木马的回显是什么。

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190529180839583-2117952951.png)

**结果显示：文件类型不正确，请重新上传！**

## （2）关于Content-Type，这是一种内容类型，一般是指网页中存在的Content-Type，用于定义网络文件的类型和网页的编码，决定浏览器将以什么形式、什么编码读取这个文件，这就是经常看到一些Asp网页点击的结果却是下载到的一个文件或一张图片的原因。（菜鸟教程详解）

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190529175315938-200910348.png)

##  （3）而原来的文件类型是怎样的呢？Content-Type:multipart/form-data     这又是一种常见的 POST 数据提交的方式。我们使用表单上传文件时，必须让 form 的 enctyped 等于这个值。首先生成了一个 boundary 用于分割不同的字段，为了避免与正文内容重复，boundary 很长很复杂。然后 Content-Type 里指明了数据是以 mutipart/form-data 来编码，以及本次请求的 boundary 是什么内容。

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531112543944-1311044865.png)

##  （4）然后，**Content-Type:application/octet-stream（ 文件以二进制流传输，不知道下载文件类型）**修改为image/gif就可以上传图片类型，这里我们是将要上传的php文件模拟为图片操作，当然，图片类型有很多种，比如：

**![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531133955036-346913651.png)**

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531124804202-1670583539.png)

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531124946423-1073274419.png)

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531125011681-2092042573.png)

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531125042692-689422294.png)

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531125103608-724434665.png)

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531125124116-1952934340.png)

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531125213013-1779302265.png)

尝试了一下jpeg与png都**可以**上传成功！

> **可以借鉴一下别人博客的内容：**
> 
> `1.1  application/json：消息主体是序列化后的 JSON 字符串  1.2  application/x-www-form-urlencoded：数据被编码为名称/值对。这是标准的编码格式  1.3  multipart/form-data： 需要在表单中进行文件上传时，就需要使用该格式。常见的媒体格式是上传文件之时使用的  1.4  text/plain：数据以纯文本形式(text/json/xml/html)进行编码，其中不含任何控件或格式字符。   `

##  （5）然后，上传成功，使用菜刀直接连接就好！这里我使用的是png类型的！

##   

## `![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531134323710-1298161735.png)`

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531134622789-438276991.png)

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531134737054-348010253.png)

                                                   _`如图，连接成功！`_

---

# 文件上传第三式（.htaccess） 

## （1）第三关的绕过技巧也特别简单，它的源码显示为不可上传asp、aspx、php、jsp

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531141034110-1349170589.png)

## 而第三关的解题思路就是上传一个包含有.htaccess的系统文件，让系统允许上传17kkk.jpg这类木马图片并解析其内容！这一关主要学习文件解析。

_**注明：**_

.htaccess文件(或者"分布式配置文件"）,全称是Hypertext Access(**超文本入口**)。提供了针对目录改变配置的方法， 即，在一个**特定的文档目录中**放置一个**包含一个或多个指令的文件**， 以**作用于此目录及其所有子目录**。

配置指令是如何被接收的？一个.htaccess文件中的配置指令**会应用于.htaccess文件的当前目录以及所有子目录**。然而，不要忘了可能还有更上层的文件目录中的.htaccess文件。配置指令按照它们被发现的顺序被应用。因此，一个.htaccess文件中的配置指令**可能会覆盖更上层的**.htaccess文件，以及apache的主配置文件中的配置指令。

> <FilesMatch "17kkk.jpg">  
> SetHandler application/x-httpd-php  
> </FilesMatch>

_`   ![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531140503891-1042494534.png)`_

##  （2）此时上传的文件是成功的，同时，它也被重新命名了！这点是由于源代码中对上传的文件进行了重命名操作！

_`![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531142413258-92036167.png)`_

## （3）此时我们继续上传一个名为17kkk.php的文件，为了与.htaccess文件对应解析，注意将17kkk的后缀修改为jpg进行上传

## **`![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531143117420-1655605014.png)`**

**我们的木马图片被上传成功，查看是否能被解析！**

---

# 文件上传第四式（正则匹配相等性）

_首先声明一下环境：php的后端开发+windows系统_

> 双引号" = 点号.  
> 大于符号> = 问号?  
> 小于符号< = 星号*

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531155438194-1945724567.png)

**源代码进行了各种脚本语言的过滤，并且还很恶俗的加上了文件重命名！**

##  （1）因此为我们可以使用这样的正则替换，比如，可以将这个文件修改为任意的文件！先上传一个名为17kkk`.php:.jpg`的文件，上传成功后会生成17kkk`.php`的空文件，大小为0KB.然后使用`17kkk.<`或`17kkk``.<<<`或`17kkk``.>>>`或`17kkk``.>><`后再次上传，重写17kkk`.php`文件内容，Webshell代码就会写入原来的`17kkk.php`空文件中。

> 然后写：test.>>>（重定向符号）
> 
> <表示_所有 ，test__表示test.*_  

## （2）将17kkk.php抓包修改为：17kkk.php:.jpg    ，在我们的upload文档内，能很明显地看到一个名为：17kkk.php的空php文档，此时我们将一句话写入到这个php文档内即可！

_![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531162508802-1690709875.png)_

_![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531162413071-955625380.png)_

**内容重定向写入的操作似乎相当有用呢！**

 ![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531163217278-15509203.png)

## （3）此时直接访问此木马文件即可成功获得webshell，注：我的php使用的是5.2.17版本的，当然，现在我们来演示一下高版本是否会触发此类漏洞！

 ![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531163526664-114009063.png)

![](https://img2018.cnblogs.com/blog/1674381/201905/1674381-20190531163617620-701476948.png)

## （4）附加测试，只报告结果，可以自行测试！Apache+Win的解析漏洞

> ### php-5.4.45亲测有效
> 
> 。。。。。。。。。。。。。。。省略无数更高版本
> 
> ###       php-5.5.38亲测有效
> 
> 。。。。。。。。。。。。。。。省略无数更高版本
> 
> ###       php-7.2.10-NTS亲测有效