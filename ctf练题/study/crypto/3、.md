
---

知道RSA算法的应该都知道公钥（n,e），如果能有效分解模数n，那么其私钥（d,p,q）我们就能获得，所以这时其就不具备安全性。但是当n为较大整数时,基于大整数分解困难，又能保证RSA是安全的。但是对大整数的分解一直被研究，相关算法有Pollard Rho算法、连分数算法（Continued fracion,CFRAC）、二次筛法（Quadratic Sieve,QS）、平方型分解法（SQUFOF）、椭圆曲线（ECM）和数域筛法（Number Field Sieve,NFS）等，有感兴趣的可以了解相关算法。根据参考文献【1】,目前有700多位（二进制）被分解，但耗时也是非常非常长的。

之前做LineCTF2021-babycrypto3题时，知道明显是RSA的大整数分解，使用了各种方式，未果，事后了解到**GGNFS和MSIEVE**分解因数  
本文就各种可能状况的分解进行简单介绍，并详细介绍一些工具的安装使用，以及针对带有`pub.pem`的公钥文件的RSA题进行简单总结

# [](https://bbs.kanxue.com/thread-266648.htm#rsa%E6%95%B4%E6%95%B0%E5%88%86%E8%A7%A3%E5%9C%BA%E6%99%AF)RSA整数分解场景

假设我们从题目获得了公钥（N，e）和待解密的密文c，由RSA的加解密过程，我们知道，如果要解密密文，我们要得到e的逆元d，而d是要我们去求解的。

- 若n较小，直接分解
- 若n较大，在线分解：http://factordb.com
- yafu工具分解  
    适用情况：p和q相差较大或相差较小时，可快速分解
    
- GGNFS和MSIEVE分解
    
- 可使用RsaCtfTool
- 一般题目中，若是可分解，使用yafu或者msieve即可分解。若是有迹可寻，也即特殊情况下，可使用相关脚本解

## [](https://bbs.kanxue.com/thread-266648.htm#n%E8%BE%83%E5%B0%8F%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%88%86%E8%A7%A3%E5%87%A0%E7%A7%8D%E7%AE%97%E6%B3%95)n较小，直接分解几种算法

### [](https://bbs.kanxue.com/thread-266648.htm#%E7%9F%AD%E9%99%A4%E6%B3%95)短除法

- 短除法1

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17<br><br>18<br><br>19<br><br>20<br><br>21<br><br>22<br><br>23<br><br>24|`# -*- coding: utf-8 -*-`<br><br>`"""短除法-1`<br><br>`从i为2开始枚举，一直枚举到，`<br><br>`一旦n % i == 0成立，则i为n的因子，`<br><br>`然后进行n //= i使运行速度加快并使i为质数才可能有n % i == 0。`<br><br>`复杂度：0（n^1/2）`<br><br>`适用范围：n: 2-10^16`<br><br>`"""`<br><br>`def` `factorization(n):`<br><br>    `i` `=` `2`<br><br>    `ret` `=` `[]`<br><br>    `while` `i` `*` `i <``=` `n:`<br><br>        `while` `n` `%` `i` `=``=` `0``:`<br><br>            `ret.append(i)`<br><br>            `n` `/``/``=` `i`<br><br>        `i` `+``=` `1`<br><br>    `if` `n >` `1``:`<br><br>        `ret.append(n)`<br><br>    `return` `ret`<br><br>`if` `__name__` `=``=` `'__main__'``:`<br><br>    `print``(factorization(``int``(``input``())))`|

|   |   |
|---|---|
|1<br><br>2|`24`<br><br>`[``2``,` `2``,` `2``,` `3``]`|

- 短除法2

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17<br><br>18<br><br>19<br><br>20<br><br>21<br><br>22<br><br>23<br><br>24<br><br>25<br><br>26<br><br>27<br><br>28<br><br>29<br><br>30<br><br>31<br><br>32<br><br>33<br><br>34<br><br>35<br><br>36<br><br>37<br><br>38<br><br>39|`# -*- coding: utf-8 -*-`<br><br>`"""短除法2`<br><br>`我们可以打表出2到n^1/2之间的质数再进行试除，这样在解决多个数的质因数分解时才会免除大部分合数的影响。`<br><br>`用素数筛进行打表复杂度为O(n)，我们也只需要从2到n^1/2打表到即可。`<br><br>`复杂度：0（n^1/2）`<br><br>`适用范围：n 2-10^12`<br><br>`"""`<br><br>`pri` `=` `[]`<br><br>`MX` `=` `int``(``1e6``)`<br><br>`isprime` `=` `[``True``]` `*` `MX`<br><br>`def` `init():`<br><br>    `global` `a, MX`<br><br>    `for` `i` `in` `range``(``2``, MX):`<br><br>        `if` `isprime[i]:`<br><br>            `pri.append(i)`<br><br>            `for` `j` `in` `range``(i` `+` `i, MX, i):`<br><br>                `isprime[j]` `=` `False`<br><br>`def` `factorization(n):`<br><br>    `global` `pri`<br><br>    `ret` `=` `[]`<br><br>    `for` `i` `in` `pri:`<br><br>        `if` `i` `*` `i > n:`<br><br>            `break`<br><br>        `while` `n` `%` `i` `=``=` `0``:`<br><br>            `ret.append(i)`<br><br>            `n` `/``/``=` `i`<br><br>    `ret.append(n)`<br><br>    `return` `ret`<br><br>`if` `__name__` `=``=` `'__main__'``:`<br><br>    `init()`<br><br>    `print``(factorization(``int``(``input``())))`|

|   |   |
|---|---|
|1<br><br>2|`21`<br><br>`[``3``,` `7``]`|

### [](https://bbs.kanxue.com/thread-266648.htm#miller-rabin%E7%B4%A0%E6%80%A7%E6%B5%8B%E8%AF%95%E5%92%8C%E7%A6%BB%E6%95%A3%E5%AF%B9%E6%95%B0pollard_rho%E5%88%86%E8%A7%A3)Miller-Rabin素性测试和离散对数Pollard_rho分解

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17<br><br>18<br><br>19<br><br>20<br><br>21<br><br>22<br><br>23<br><br>24<br><br>25<br><br>26<br><br>27<br><br>28<br><br>29<br><br>30<br><br>31<br><br>32<br><br>33<br><br>34<br><br>35<br><br>36<br><br>37<br><br>38<br><br>39<br><br>40<br><br>41<br><br>42<br><br>43<br><br>44<br><br>45<br><br>46<br><br>47<br><br>48<br><br>49<br><br>50<br><br>51<br><br>52<br><br>53<br><br>54<br><br>55<br><br>56<br><br>57<br><br>58<br><br>59<br><br>60<br><br>61<br><br>62<br><br>63<br><br>64<br><br>65<br><br>66<br><br>67<br><br>68<br><br>69<br><br>70<br><br>71<br><br>72<br><br>73<br><br>74<br><br>75<br><br>76<br><br>77<br><br>78<br><br>79<br><br>80<br><br>81<br><br>82<br><br>83<br><br>84<br><br>85<br><br>86<br><br>87<br><br>88<br><br>89<br><br>90<br><br>91<br><br>92<br><br>93<br><br>94<br><br>95<br><br>96|`# -*- coding: utf-8 -*-`<br><br>`"""`<br><br>`用Miller-Rabin素性测试和离散对数Pollard_rho算法进行大数因数分解：`<br><br>`复杂度：0(n^1/4)`<br><br>`适用范围：n 2-10^33`<br><br>`"""`<br><br>`import` `random`<br><br>`from` `math` `import` `log, log10`<br><br>`from` `collections` `import` `Counter`<br><br>`def` `gcd(x, y):`<br><br>    `return` `x` `if` `y` `=``=` `0` `else` `gcd(y, x` `%` `y)`<br><br>`def` `fpow(a, x, n):`<br><br>    `ans` `=` `1`<br><br>    `while` `x >` `0``:`<br><br>        `if` `x &` `1``:`<br><br>            `ans` `=` `ans` `*` `a` `%` `n`<br><br>        `a` `=` `a` `*` `a` `%` `n`<br><br>        `x >>``=` `1`<br><br>    `return` `ans`<br><br>`# there change the times of Rabin-Miller`<br><br>`TIMES` `=` `10`<br><br>`def` `is_prime(n):`<br><br>    `def` `check(a, n, x, t):`<br><br>        `ret` `=` `fpow(a, x, n)`<br><br>        `last` `=` `ret`<br><br>        `for` `i` `in` `range``(``0``, t):`<br><br>            `ret` `=` `ret` `*` `ret` `%` `n`<br><br>            `if` `ret` `=``=` `1` `and` `last !``=` `1` `and` `last !``=` `n` `-` `1``:`<br><br>                `return` `True`<br><br>            `last` `=` `ret`<br><br>        `if` `ret !``=` `1``:`<br><br>            `return` `True`<br><br>        `return` `False`<br><br>    `if` `not` `isinstance``(n,` `int``):`<br><br>        `raise` `TypeError(``str``(n)` `+` `' is not an integer!'``)`<br><br>    `if` `n <``=` `0``:`<br><br>        `raise` `ValueError(``'%d <= 0'` `%` `n)`<br><br>    `if` `n` `in` `{``2``,` `3``,` `5``,` `7``,` `11``}:`<br><br>        `return` `True`<br><br>    `for` `i` `in` `{``2``,` `3``,` `5``,` `7``,` `11``}:`<br><br>        `if` `n` `%` `i` `=``=` `0``:`<br><br>            `return` `False`<br><br>    `x` `=` `n` `-` `1`<br><br>    `t` `=` `0`<br><br>    `while` `not` `x &` `1``:`<br><br>        `x >>``=` `1`<br><br>        `t` `+``=` `1`<br><br>    `for` `i` `in` `range``(``0``, TIMES):`<br><br>        `a` `=` `random.randint(``1``, n` `-` `2``)`<br><br>        `if` `check(a, n, x, t):`<br><br>            `return` `False`<br><br>    `return` `True`<br><br>`def` `pollard_rho_2(n, c):`<br><br>    `x` `=` `random.randint(``0``, n)`<br><br>    `i, k, y` `=` `1``,` `2``, x`<br><br>    `while` `True``:`<br><br>        `i` `+``=` `1`<br><br>        `x` `=` `(x` `*` `x)` `%` `n` `+` `c`<br><br>        `d` `=` `gcd(y` `-` `x, n)`<br><br>        `if` `d !``=` `1` `and` `d !``=` `n:`<br><br>            `return` `d`<br><br>        `if` `y` `=``=` `x:`<br><br>            `return` `n`<br><br>        `if` `i` `=``=` `k:`<br><br>            `y` `=` `x`<br><br>            `k <<``=` `1`<br><br>`def` `pollard_rho_1(n):`<br><br>    `if` `not` `isinstance``(n,` `int``):`<br><br>        `raise` `TypeError(``str``(n)` `+` `' is not an integer!'``)`<br><br>    `if` `n` `=``=` `1``:`<br><br>        `return` `None`<br><br>    `if` `is_prime(n):`<br><br>        `return` `[n]`<br><br>    `ans` `=` `[]`<br><br>    `p` `=` `n`<br><br>    `while` `p >``=` `n:`<br><br>        `p` `=` `pollard_rho_2(p, random.randint(``1``, n` `-` `1``))`<br><br>    `ans.extend(pollard_rho_1(p))`<br><br>    `ans.extend(pollard_rho_1(n` `/``/` `p))`<br><br>    `return` `ans`<br><br>`def` `factorization(n):`<br><br>    `return` `Counter(pollard_rho_1(n))`<br><br>`if` `__name__` `=``=` `'__main__'``:`<br><br>    `n` `=` `int``(``input``())`<br><br>    `print``(``'len:'``,` `len``(``str``(n)))`<br><br>    `print``(factorization(n))`|

|   |   |
|---|---|
|1<br><br>2<br><br>3|`33`<br><br>`len``:` `2`<br><br>`Counter({``3``:` `1``,` `11``:` `1``})`|

## [](https://bbs.kanxue.com/thread-266648.htm#n%E8%BE%83%E5%A4%A7%EF%BC%8C%E5%9C%A8%E7%BA%BF%E6%9F%A5%E6%89%BE)n较大，在线查找

当n较大时，若用常用的工具无法分解，可利用在线网站：http://factordb.com

## [](https://bbs.kanxue.com/thread-266648.htm)Wiener's attack

### [](https://bbs.kanxue.com/thread-266648.htm#%E9%80%82%E7%94%A8%E6%83%85%E5%86%B5)适用情况

适用情况：e过大或过小。  
在e过大或过小的情况下，可使用算法从e中快速推断出d的值。详细的算法原理可以阅读：低解密指数攻击  
https://www.tr0y.wang/2017/11/06/CTFRSA/index.html#%E4%BD%8E%E8%A7%A3%E5%AF%86%E6%8C%87%E6%95%B0%E6%94%BB%E5%87%BB

wiener's attack代码参考：https://github.com/pablocelayes/rsa-wiener-attack

下面内容摘自上面参考博客

### [](https://bbs.kanxue.com/thread-266648.htm#%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D)简单介绍

![](https://bbs.kanxue.com/upload/attach/202103/920608_AYDPK4T6TAP67S8.jpg)

![](https://bbs.kanxue.com/upload/attach/202103/920608_KCS4JBFE6NP7NQW.jpg)

### [](https://bbs.kanxue.com/thread-266648.htm#%E4%BB%A3%E7%A0%81)代码

- python2代码

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17<br><br>18<br><br>19<br><br>20<br><br>21<br><br>22<br><br>23<br><br>24<br><br>25<br><br>26<br><br>27<br><br>28<br><br>29<br><br>30<br><br>31<br><br>32<br><br>33<br><br>34<br><br>35<br><br>36<br><br>37<br><br>38<br><br>39<br><br>40<br><br>41<br><br>42<br><br>43<br><br>44<br><br>45<br><br>46<br><br>47<br><br>48<br><br>49<br><br>50|`# -*- coding: utf-8 -*-`<br><br>`import` `gmpy2`<br><br>`import` `time`<br><br>`# 展开为连分数`<br><br>`def` `continuedFra(x, y):`<br><br>    `cF` `=` `[]`<br><br>    `while` `y:`<br><br>        `cF` `+``=` `[x` `/` `y]`<br><br>        `x, y` `=` `y, x` `%` `y`<br><br>    `return` `cF`<br><br>`def` `Simplify(ctnf):`<br><br>    `numerator` `=` `0`<br><br>    `denominator` `=` `1`<br><br>    `for` `x` `in` `ctnf[::``-``1``]:`<br><br>        `numerator, denominator` `=` `denominator, x` `*` `denominator` `+` `numerator`<br><br>    `return` `(numerator, denominator)`<br><br>`# 连分数化简`<br><br>`def` `calculateFrac(x, y):`<br><br>    `cF` `=` `continuedFra(x, y)`<br><br>    `cF` `=` `map``(Simplify, (cF[``0``:i]` `for` `i` `in` `xrange``(``1``,` `len``(cF))))`<br><br>    `return` `cF`<br><br>`# 解韦达定理`<br><br>`def` `solve_pq(a, b, c):`<br><br>    `par` `=` `gmpy2.isqrt(b` `*` `b` `-` `4` `*` `a` `*` `c)`<br><br>    `return` `(``-``b` `+` `par)` `/` `(``2` `*` `a), (``-``b` `-` `par)` `/` `(``2` `*` `a)`<br><br>`def` `wienerAttack(e, n):`<br><br>    `for` `(d, k)` `in` `calculateFrac(e, n):`<br><br>        `if` `k` `=``=` `0``:` `continue`<br><br>        `if` `(e` `*` `d` `-` `1``)` `%` `k !``=` `0``:` `continue`<br><br>        `phi` `=` `(e` `*` `d` `-` `1``)` `/` `k`<br><br>        `p, q` `=` `solve_pq(``1``, n` `-` `phi` `+` `1``, n)`<br><br>        `if` `p` `*` `q` `=``=` `n:`<br><br>            `return` `abs``(``int``(p)),` `abs``(``int``(q))`<br><br>    `print` `'not find!'`<br><br>`time.clock()`<br><br>`n` `=` `0x92411fa0c93c1b27f89e436d8c4698bcf554938396803a5b62bd10c9bfcbf85a483bd87bb2d6a8dc00c32d8a7caf30d8899d90cb8f5838cae95f7ff5358847db1244006c140edfcc36adbdcaa16cd27432b4d50d2348b5c15c209364d7914ef50425e4c3da07612cc34e9b93b98d394b43f3eb0a5a806c70f06697b6189606eb9707104a7b6ff059011bac957e2aae9ec406a4ff8f8062400d2312a207a9e018f4b4e961c943dfc410a26828d2e88b24e4100162228a5bbf0824cf2f1c8e7b915efa385efeb505a9746e5d19967766618007ddf0d99525e9a41997217484d64c6a879d762098b9807bee46a219be76941b9ff31465463981e230eecec69691d1`<br><br>`e` `=` `0x6f6b385dd0f06043c20a7d8e5920802265e1baab9d692e7c20b69391cc5635dbcaae59726ec5882f168b3a292bd52c976533d3ad498b7f561c3dc01a76597e47cfe60614f247551b3dbe200e2196eaa001a1d183886eeacddfe82d80b38aea24de1a337177683ed802942827ce4d28e20efef92f38f1b1a18c66f9b45f5148cceabfd736de8ac4a49e63a8d35a83b664f9f3b00f822b6f11ff13257ee6e0c00ca5c98e661ea594a9e66f2bd56b33d9a13f5c997e67a37fcf9a0c7f04d119fe1ba261127357e64a4b069aefed3049c1c1fe4f964fd078b88bedd064abea385cfebd65e563f93c12d34eb6426e8aa321033cfd8fe8855b9e74d07fe4f9d70de46f`<br><br>`c` `=` `0x558b353e0bff6f006eddf2ee35bf7114a60f22228462e0b6289bc9d824fa4d5988b68d41960b16f89bd33b7a51d5de6ad9afe9e1e5fa778d7d44f3df5b4b482c00913fc2fb78a3fb4714b651e6fde2df8f2adffd7c4a6a344d112938c1818cae8439615ac9dbe5ebf6d0ee4a672664f4067389e38eedc900d3874424a29234b1bbd736468506427d81bfa4080c1f114a9165feec1b5b721bafcdf33b4ce5b84881192d7b84246c73aca1e570e1805a522b3f0693590fb14a49bbdbf856155b4f37f3432532b9e9fe615d1f90011319d13de9c224c6f709b497538f705f95374172f7ee423ef0db6b3969ac4aab780d630d2bed75f140a276fddfccd224ee024`<br><br>`print``(``'e'``,e,``'n'``,n)`<br><br>`p, q` `=` `wienerAttack(e, n)`<br><br>`print` `'[+]Found!'`<br><br>`print` `'  [-]p ='``,p`<br><br>`print` `'  [-]q ='``,q`<br><br>`print` `'  [-]n ='``,p``*``q`<br><br>`d` `=` `gmpy2.invert(e,(p``-``1``)``*``(q``-``1``))`<br><br>`print` `'  [-]d ='``, d`<br><br>`print` `'  [-]m is:'` `+` `'{:x}'``.``format``(``pow``(c,d,n)).decode(``'hex'``)`<br><br>`print` `'\n[!]Timer:'``,` `round``(time.clock(),``2``),` `'s'`<br><br>`print` `'[!]All Done!'`|

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10|`(``'e'``,` `14065324093316017945695720258347429532521523200228598193322667338820770590989154977786981894794588594064536009186732255775035804405327706425255296803855527639374329558376563095664859692148197185703687276097309462020144376262777557533944519562049109221719648126706993033163993490190085491702629251352329396471456129542825658446009162968346786594848548139595669836329358788165100849817671092568134531593182392252696719165573226130084180843486935720502707239300540428534291779101061922644007823991998086019198292035392258539304441052201138357754863223836486846439513422901513872417295274198920142360883876210212927825007L``,` `'n'``,` `18462906143035540993814517057095163128283817787230664517838986634801013392767711846485937113330072380038567780269061919808605648774959966319179757205173372523095161810322702620470126948608656351385935375720727519176775110406692586449768317335765421930399299578230419560189633716571287406027463911286833332787737419540756653612611709926058384814812935770145166745335145087323852211057246522872067333040272572190577262813212787729743380140592301701193918348912668992966189995193003441075512789075254845693251194059243188025613215624222354768281910170062917473229700929505219308776883069798326608764552258161920559190481L``)`<br><br>`[``+``]Found!`<br><br>  `[``-``]p` `=` `104235442847969552884769987994197297422543352176802940317177677000499807722195632069286150361214879780730339973882703487096199834739930880687593938040395436586345480730212942206420793142692112306639438014319225266407401819137390988067078857106773391577174349673013152862143650835518682246788303050611999452911`<br><br>  `[``-``]q` `=` `177126950666523578738984064380839651168608739644946060823792396091708111322051866642111785827074573440159197219479475538437582278979185941268904558179007415168216637577906599474105547898107223364283435084419522228187779674837611069387527478313869377950991632158274789401880909076604812300066218450595389655871`<br><br>  `[``-``]n` `=` `18462906143035540993814517057095163128283817787230664517838986634801013392767711846485937113330072380038567780269061919808605648774959966319179757205173372523095161810322702620470126948608656351385935375720727519176775110406692586449768317335765421930399299578230419560189633716571287406027463911286833332787737419540756653612611709926058384814812935770145166745335145087323852211057246522872067333040272572190577262813212787729743380140592301701193918348912668992966189995193003441075512789075254845693251194059243188025613215624222354768281910170062917473229700929505219308776883069798326608764552258161920559190481`<br><br>  `[``-``]d` `=` `42043`<br><br>  `[``-``]m` `is``:flag{w13n3r_4tt4ck_d_1s_10w}`<br><br>`[!]Timer:` `40.97` `s`<br><br>`[!]``All` `Done!`|

## [](https://bbs.kanxue.com/thread-266648.htm#%E8%B4%B9%E9%A9%AC%E5%88%86%E8%A7%A3)费马分解

### [](https://bbs.kanxue.com/thread-266648.htm#%E9%80%82%E7%94%A8%E6%83%85%E5%86%B5)适用情况

当大整数N的两个因子p和q相近时，我们可以通过费马分解的办法很快分解大整数

### [](https://bbs.kanxue.com/thread-266648.htm#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B)代码示例

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17<br><br>18<br><br>19<br><br>20<br><br>21<br><br>22<br><br>23<br><br>24<br><br>25<br><br>26<br><br>27<br><br>28<br><br>29<br><br>30<br><br>31<br><br>32<br><br>33|`from` `isqrt` `import` `isqrt`<br><br>`def` `fermat(n):`<br><br>    `a` `=` `isqrt(n)`<br><br>    `b2` `=` `a` `*` `a` `-` `n`<br><br>    `b` `=` `isqrt(n)`<br><br>    `count` `=` `0`<br><br>    `while` `b` `*` `b !``=` `b2:`<br><br>        `a` `=` `a` `+` `1`<br><br>        `b2` `=` `a` `*` `a` `-` `n`<br><br>        `b` `=` `isqrt(b2)`<br><br>        `count` `+``=` `1`<br><br>    `p` `=` `a` `+` `b`<br><br>    `q` `=` `a` `-` `b`<br><br>    `assert` `n` `=``=` `p` `*` `q`<br><br>    `return` `p, q`<br><br>`if` `__name__` `=``=` `'__main__'``:`<br><br>    `import` `libnum`<br><br>    `N``=``966808932627497190635859236054960349099463975227350564265384373280336699853387254070662881265937565163000758606154308757944030571837175048514574473061401566330836334647176655282619268592560172726526643074499534129878217409046045533656897050117438496357231575999185527675071002803951800635220029015932007465117818739948903750200830856115668691007706836952244842719419452946259275251773298338162389930518838272704908887016474007051397194588396039111216708866214614779627566959335170676055025850932631053641576566165694121420546081043285806783239296799795655191121966377590175780618944910532816988143056757054052679968538901460893571204904394975714081055455240523895653305315517745729334114549756695334171142876080477105070409544777981602152762154610738540163796164295222810243309051503090866674634440359226192530724635477051576515179864461174911975667162597286769079380660782647952944808596310476973939156187472076952935728249061137481887589103973591082872988641958270285169650803792395556363304056290077801453980822097583574309682935697260204862756923865556397686696854239564541407185709940107806536773160263764483443859425726953142964148216209968437587044617613518058779287167853349364533716458676066734216877566181514607693882375533`<br><br>    `e``=``65537`<br><br>    `c``=``168502910088858295634315070244377409556567637139736308082186369003227771936407321783557795624279162162305200436446903976385948677897665466290852769877562167487142385308027341639816401055081820497002018908896202860342391029082581621987305533097386652183849657065952062433988387640990383623264405525144003500286531262674315900537001845043225363148359766771033899680111076181672797077410584747509581932045540801777738548872747597899965366950827505529432483779821158152928899947837196391555666165486441878183288008753561108995715961920472927844877569855940505148843530998878113722830427807926679324241141182238903567682042410145345551889442158895157875798990903715105782682083886461661307063583447696168828687126956147955886493383805513557604179029050981678755054945607866353195793654108403939242723861651919152369923904002966873994811826391080318146260416978499377182540684409790357257490816203138499369634490897553227763563553981246891677613446390134477832143175248992161641698011195968792105201847976082322786623390242470226740685822218140263182024226228692159380557661591633072091945077334191987860262448385123599459647228562137369178069072804498049463136233856337817385977990145571042231795332995523988174895432819872832170029690848`<br><br>    `p,q``=``fermat(N)`<br><br>    `print``(``"p:"``,p)`<br><br>    `print``(``"q:"``,q)`<br><br>    `# 根据p,q求phi_n也即N的欧拉函数值`<br><br>    `phi_n``=``(p``-``1``)``*``(q``-``1``)`<br><br>    `# 求d`<br><br>    `d``=` `libnum.invmod(e,phi_n)`<br><br>    `# 用d解密`<br><br>    `flag``=``libnum.n2s(``pow``(c,d,N))`<br><br>    `print``(flag)`|

|   |   |
|---|---|
|1<br><br>2<br><br>3|`p:` `31093551302922880999883020803665536616272147022877428745314830867519351013248914244880101094365815998050115415308439610066700139164376274980650005150267949853671653233491784289493988946869396093730966325659249796545878080119206283512342980854475734097108975670778836003822789405498941374798016753689377992355122774401780930185598458240894362246194248623911382284169677595864501475308194644140602272961699230282993020507668939980205079239221924230430230318076991507619960330144745307022538024878444458717587446601559546292026245318907293584609320115374632235270795633933755350928537598242214216674496409625928997877221`<br><br>`q:` `31093551302922880999883020803665536616272147022877428745314830867519351013248914244880101094365815998050115415308439610066700139164376274980650005150267949853671653233491784289493988946869396093730966325659249796545878080119206283512342980854475734097108975670778836003822789405498941374798016753689377992355122774401780930185598458240894362246194248623911382284169677595864501475308194644140602272961699230282993020507668939980205079239221924230430230318076991507619960330144745307022538024878444458717587446601559546292026245318907293584609320115374632235270795633933755350928537598242214216674496409625928797450473`<br><br>`flag{d1fference_between_p_And_q_1s_t00_5mall}`|

# [](https://bbs.kanxue.com/thread-266648.htm#ggnfs%E5%92%8Cmsieve%E5%88%86%E8%A7%A3)GGNFS和MSIEVE分解

## [](https://bbs.kanxue.com/thread-266648.htm#windows%E4%B8%8B%E5%AE%89%E8%A3%85)windows下安装

官网：http://gilchrist.ca/jeff/factoring/nfs_beginners_guide_perl.html

以及翻译：https://bbs.pediy.com/thread-156206.htm

- 使用Number Field Sieve（NFS）算法分解大于90位的数字，我们可使用GGNFS和MSIEVE软件工具来完成此任务。
- 对于小于90位的数字，应将二次筛（QS）与MSIEVE或YAFU之类的程序一起使用。
- 为要分解的数字大小选择一个合理的分解算法很重要。例如，下面的100位整数使用ECM算法花费了将近80天的时间，而GNFS仅需几个小时。同样，少数数据应使用除GNFS之外的其他因素（例如ECM或QS）进行分解。

下面示例：如何使用通用数字字段筛（GNFS）和Brian Gladman的factmsieve.py python脚本同时使用ggnfs和msieve工具对以下100位整数进行因子分解：2881039827457895971881627053137530734638790825166127496066674320241571446494762386620429538

### [](https://bbs.kanxue.com/thread-266648.htm#ecm%E5%9C%A8%E7%BA%BF%E5%92%8Cwindows%E4%B8%8Byafu%E5%88%86%E8%A7%A3%E6%B5%8B%E8%AF%95)ECM在线和windows下yafu分解测试

- ECM在线分解大整数：https://www.alpertron.com.ar/ECM.HTM
    
    > ECM和SIQS（二次筛法）结合
    

![](https://bbs.kanxue.com/upload/attach/202103/920608_EUPN6K9MRP3XHJA.jpg)

在线ECM测试结果：2 881039 827457 895971 881627 053137 530734 638790 825166 127496 066674 320241 571446 494762 386620 429538（91个数字）= 2×59×107×283×100469 ×25212824 127811 771907 702100 117027 070259（38个数字）×318305309 664993 （42位数字）

用时：12m 21.4s

- yafu分解测试
    
    > 输入.yafu-x64.exe后回车再输入factor(number)
    

![](https://bbs.kanxue.com/upload/attach/202103/920608_S2B9Z5DZYMJG9A9.jpg)

用时285.2031秒

### [](https://bbs.kanxue.com/thread-266648.htm#%E4%B8%8B%E8%BD%BDmsieve)下载msieve

下载地址：https://sourceforge.net/projects/msieve/

下载完后将其内容复制添加至ggnfs文件夹中

### [](https://bbs.kanxue.com/thread-266648.htm#%E4%B8%8B%E8%BD%BDggnfs)下载ggnfs

- 先下载：factmsieve.py
    
    > 参考链接：http://brg.a2hosted.com/oldsite/computing/factmsieve.py
    

- 再下载ggnfs

下载地址：https://sourceforge.net/projects/ggnfs/

因为我的电脑是windows自动检测下载的exe文件，然后下载即可

下载完成ggnfs文件夹内容如下图：下载后并没有def-nm-params.txt和def-par.txt这两个文件  
可从网站：https://github.com/MersenneForum/ggnfs/tree/master/bin 中下载这两个文件

![](https://bbs.kanxue.com/upload/attach/202103/920608_PF5G4XUJ2ZJQP5K.jpg)

- 创建一个工作目录C:xxxxxx\ggnfs\example

### [](https://bbs.kanxue.com/thread-266648.htm#%E4%BF%AE%E6%94%B9factmsieve.py%E6%96%87%E4%BB%B6)修改factmsieve.py文件

- 使用notepad++修改factmsieve.py文件
    
    Change lines 63-64 from:  
    注：Set binary directory paths  
    GGNFS_PATH = 'C:/Users/brg\Documents/Visual Studio 2015/Projects/ggnfs/bin/x64/Release'  
    MSIEVE_PATH = 'C:/Users/brg/Documents/Visual Studio 2015/Projects/msieve/bin/x64/Release'
    
    to:
    
    注：Set binary directory paths  
    GGNFS_PATH = '../'  
    MSIEVE_PATH = '../'
    

- 查看自己电脑的CPU核数，命令行输入 wmic ，再输入cpu get

|   |   |
|---|---|
|1<br><br>2|`C:\Users\xxx>wmic`<br><br>`wmic:root\cli>cpu get`|

滑动底部得到，如图所示：  
![](https://bbs.kanxue.com/upload/attach/202103/920608_7PNPK3Z34G8HGZX.jpg)

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4|`修改``67` `from``:`<br><br>`NUM_CPUS` `=` `4`<br><br>`to 若你的CPU为双核，可选``1``或``2``；若为四核，则可选``1``,``2``,``3``,``4`<br><br>`NUM_CPUS` `=` `4`|

- 默认情况下，factmsieve.py将使用msieve进行多项式选择。普通用户应该保留这个设置。如果出于某些原因，你想使用pol51多项式选择工具更做下面更改
    
    change lines 89-90 from:  
    USE_KLEINJUNG_FRANKE_PS = False  
    USE_MSIEVE_POLY = True  
    to:  
    USE_KLEINJUNG_FRANKE_PS = True  
    USE_MSIEVE_POLY = False
    
- GPU
    
    如果您使用的是启用了 GPU 的 msieve 版本，并且希望使用 GPU 启用多项式选择，请修改第 70 行，确保它写着。  
    USE_CUDA = True  
    如果您没有使用GPU，请确保它写着:  
    USE_CUDA = False
    
    在第104行，如果你使用的不是'msieve'，请确保你的msieve可执行文件被正确命名。我的是msieve153故这里改为msieve153  
    MSIEVE = 'msieve153'
    

由于我的本机运行出错，故将CUDA设置False

进入下一步

### [](https://bbs.kanxue.com/thread-266648.htm#%E5%A4%9A%E9%A1%B9%E5%BC%8F%E9%80%89%E6%8B%A9)多项式选择

NFS算法采用了3个阶段的方法，首先是**多项式选择，然后是筛分，最后是线性代数**。 在分解开始之前，必须先选择一个多项式。  
factmsieve.py脚本将运行适当的工具为你选择一个。

windows下在上面创建的example文件夹中，创建example.n文件，该文件内容为：  
n:2881039827457895971881627053137530734638790825166127496066674320241571446494762386620442953820735453

windows在example工作目录运行：

|   |   |
|---|---|
|1|`C:xxxx\ggnfs\example> python ..\factmsieve.py example`|

如下图：  
![](https://bbs.kanxue.com/upload/attach/202103/920608_ATXDSD2TTP54HFT.jpg)

至此windows下已安装完成

## [](https://bbs.kanxue.com/thread-266648.htm#linux%E4%B8%8B%E5%AE%89%E8%A3%85)Linux下安装

下载msieve：https://github.com/MersenneForum/msieve  
其中包含了gnfs我们就直接在该文件夹下,终端输入make all即可

我使用的是kail所以命令如下：

|   |   |
|---|---|
|1|`root@kali:~``/``myctf``/``msieve``# make all`|

# [](https://bbs.kanxue.com/thread-266648.htm#%E9%A2%98%E7%9B%AE-linectf2021-babycrypto3)题目-LineCTF2021-babycrypto3

Plesase decrypt and get flag.

Flag is LINECTF{<decryped text>} and  
decrypted text is human-readable text.

- 附件：ciphertext.txt和pub.pem

# [](https://bbs.kanxue.com/thread-266648.htm#%E9%A2%98%E8%A7%A3)题解

## [](https://bbs.kanxue.com/thread-266648.htm#%E5%88%86%E6%9E%90%E5%AF%86%E6%96%87)分析密文

- ciphertext.txt文件内容

|   |   |
|---|---|
|1<br><br>2<br><br>3|`with` `open``(``'ciphertext.txt'``,``'rb'``) as f:`<br><br>    `hex_c``=``f.read()`<br><br>`print``(hex_c)`|

|   |   |
|---|---|
|1|`b```'\x01\x14\x1fUxa\xaa\xb3C\x9b\xe1\xeb\x87\xa0\x12`\x156e\x8a\x05\xf4\xf3x\xf7\xb9\xda\xe5J\x08Cn\\C]V\xdd\x1bH\x96\xb74\xae\xcd\x83\x88A\xd5\x92&'``|

- 将字节转换为整数

|   |   |
|---|---|
|1<br><br>2<br><br>3|`from` `Crypto.Util.number` `import` `long_to_bytes, bytes_to_long`<br><br>`cipher``=``bytes_to_long(hex_c)`<br><br>`cipher`|

|   |   |
|---|---|
|1|`10879776433900426660843740332190892429769159527203392037251077478777616065501519198653853699716123394455804888854401574`|

## [](https://bbs.kanxue.com/thread-266648.htm#%E8%A7%A3%E6%9E%90%E5%85%AC%E9%92%A5%E6%96%87%E4%BB%B6)解析公钥文件

### [](https://bbs.kanxue.com/thread-266648.htm#%E6%96%B9%E5%BC%8F1%EF%BC%9Aopenssl%E8%BD%AF%E4%BB%B6)方式1：OpenSSL软件

|   |   |
|---|---|
|1|`命令：rsa` `-``pubin` `-``in` `pub.pem` `-``text` `-``modulus`|

如图

![](https://bbs.kanxue.com/upload/attach/202103/920608_E5YFMY8YDSQEV8N.jpg)

### [](https://bbs.kanxue.com/thread-266648.htm#%E6%96%B9%E5%BC%8F2%EF%BC%9Apython%E5%BA%93rsa)方式2：Python库RSA

- 获取公钥（e,n）

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6|`from` `Crypto.PublicKey` `import` `RSA`<br><br>`with` `open``(``'pub.pem'``,` `'r'``) as f:`<br><br>    `pubkey``=``f.read()`<br><br>`key` `=` `RSA.importKey(pubkey)`<br><br>`e,n``=``key.e,key.n`<br><br>`e,n`|

|   |   |
|---|---|
|1<br><br>2|`(``65537``,`<br><br> `31864103015143373750025799158312253992115354944560440908105912458749205531455987590931871433911971516176954193675507337``)`|

## [](https://bbs.kanxue.com/thread-266648.htm#%E5%88%86%E8%A7%A3n)分解n

查看n的位数

|   |   |
|---|---|
|1|`len``(``bin``(n))``-``2``# bit`|

|   |   |
|---|---|
|1|`394`|

说明可分，首先在http://factordb.com 查找，比赛时是查不出来的，目前已经有提交给这个网站，故现在是可查的

由于本机线程过小，跑的时间过长就直接粘贴网址查询的p和q

|   |   |
|---|---|
|1<br><br>2|`p` `=` `291664785919250248097148750343149685985101`<br><br>`q` `=` `109249057662947381148470526527596255527988598887891132224092529799478353198637`|

## [](https://bbs.kanxue.com/thread-266648.htm#%E8%A7%A3%E5%AF%86)解密

- 由上文已知，n,e,p,q

直接利用RSA加解密原理

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4|`import` `libnum`<br><br>`d``=` `libnum.invmod(e,(p``-``1``)``*``(q``-``1``))`<br><br>`m``=``pow``(cipher,d,n)`<br><br>`long_to_bytes(m)`|

|   |   |
|---|---|
|1|`b```'\x02`g\xff\x85\x1e\xcd\xcba\xe5\x0b\x83\xa5\x15\xe3\x00Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==\n'``|

- 观察到有base64编码

|   |   |
|---|---|
|1<br><br>2|`import` `base64`<br><br>`print``(base64.b64decode(``'Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg=='``.encode()))`|

|   |   |
|---|---|
|1|`b``'CLOSING THE DISTANCE.\n'`|

可知flag为：LINECTF{CLOSING THE DISTANCE.}

- 完整代码

|   |   |
|---|---|
|1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17<br><br>18|`from` `Crypto.PublicKey` `import` `RSA`<br><br>`from` `Crypto.Util.number` `import` `long_to_bytes,bytes_to_long`<br><br>`import` `base64`<br><br>`import` `libnum`<br><br>`with` `open``(``'ciphertext.txt'``,``'rb'``) as f:`<br><br>    `cipher``=``bytes_to_long(f.read())`<br><br>`with` `open``(``'pub.pem'``,``'r'``) as fp:`<br><br>    `key` `=` `RSA.importKey(fp.read())`<br><br>`n,e` `=` `key.n,key.e`<br><br>`print``(n,e)`<br><br>`p` `=` `291664785919250248097148750343149685985101`<br><br>`q` `=` `109249057662947381148470526527596255527988598887891132224092529799478353198637`<br><br>`# 计算d`<br><br>`d``=` `libnum.invmod(e,(p``-``1``)``*``(q``-``1``))`<br><br>`m` `=``pow``(cipher,d,n)`<br><br>`print``(long_to_bytes(m))`|

|   |   |
|---|---|
|1<br><br>2|`31864103015143373750025799158312253992115354944560440908105912458749205531455987590931871433911971516176954193675507337` `65537`<br><br>`b```'\x02`g\xff\x85\x1e\xcd\xcba\xe5\x0b\x83\xa5\x15\xe3\x00Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==\n'``|

# [](https://bbs.kanxue.com/thread-266648.htm#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE)参考文献

- [1]王兴波,唐春明,李建辉.公钥密码体制中大整数分解算法研究[J].现代信息科技,2020,4(16):125-133.
    
- https://github.com/x-vespiary/writeup/blob/master/2021/03-line/crypto-babycrypto3.md
    
- http://gilchrist.ca/jeff/factoring/nfs_beginners_guide.html